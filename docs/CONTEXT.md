# Worker Analytics — Контекст проекта
> Последнее обновление: 2025-10-20T17:59:21+03:00

## Цель
Внутренний сайт для компании: аналитика продаж, планирование продаж, расчёт заработной платы.

## Текущая платформа
- Бэкенд: FastAPI (Python 3.10), Uvicorn
- БД: PostgreSQL
- Статика: простой JS (`app/static/dashboard.js`)
- Интеграции: МойСклад (Remap 1.2 API)
- Деплой: вручную на VPS Ubuntu 22.04

## Источники данных (МойСклад)
- Продажи (чеки/позиции)
- Оприходования (inflow)
- Списания (loss) с разбивкой по причинам
- Справочники: склады, товары, категории, клиенты

## Часовой пояс
- Все отчёты: Asia/Yakutsk (UTC+9). В БД хранить UTC, на уровне витрин и фильтров приводить к Asia/Yakutsk.

## API (текущее минимум)
- `GET /api/revenue/daily?days=...` — выручка по дням
- `GET /api/margin/daily?days=...` — GP/маржа по дням
- `GET /api/inflow/daily?days=...` — оприходования по дням
- `GET /api/top/warehouses?start&end` — топ складов
- `GET /api/top/products_v3?start&end&limit&sort_by&order&min_qty&min_revenue` — топ товаров (v3)
- `GET /dashboard` — UI (грузит `/static/dashboard.js`)

## Фронтенд — фильтры периода (согласовано)
Быстрые кнопки: Сегодня, Вчера, Текущая неделя (Пн 00:00 — вчера 23:59), 7 дней (до вчера), Текущий месяц (с 1-го по вчера), Прошлый месяц, Текущий год (до вчера), Прошлый год. Фильтр влияет на все блоки.

## Что болит/ограничения сейчас
- Синк списаний: падал 400 от API (нужно поправить фильтр moment и авторизацию).
- Были костыли в импортах (`app.main` ловил ошибки import); временно обёрнуты заглушками.
- Нужны системные таймеры и журналирование для регулярных синков.

## Целевой стек (план)
Postgres + dbt + Prefect + FastAPI + Celery/Redis + Next.js + ECharts + Docker + Sentry/Grafana.

## Переменные окружения (черновик)
- `DATABASE_URL=postgresql+psycopg://user:pass@host:5432/db`
- `MS_API_TOKEN=...` (или `MS_TOKEN=...` — договориться об одном названии)
- `MS_BASE_URL=https://api.moysklad.ru/api/remap/1.2`
- `TZ=Asia/Yakutsk`
- `SECRET_KEY=...` (сессии)
